<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <link rel="stylesheet" href="style.css">
  <title>Document</title>
  <script crossorigin src="https://unpkg.com/react@16/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@16/umd/react-dom.development.js"></script>
  <script crossorigin src="https://unpkg.com/babel-standalone@6/babel.js"></script>
</head>
<body>

<div id="root"></div>

</body>
<script type="text/jsx">

  //State

  const initialState = {

  }

  const SET_TIME = 'SET_TIME'

  function setTime(time) {
    return {
      type: SET_TIME,
      time
    }
  }

  const clockInitialState = {
      time: new Date()
  }

  function clockReducer(state = clockInitialState, action) {
    switch(action.type) {
      case SET_TIME:
        return {
          ...state,
          time: action.time
        }
      default:
        return state
    }
  }


  const SET_LOTS = 'SET_LOTS'
  const CHANGE_LOT_PRICE = 'CHANGE_LOT_PRICE'

  const auctionInitialState = {
     lots: null
  }

  function setLots(lots) {
    return {
      type: SET_LOTS,
      lots
    }
  }

  function changeLotPrice(id, price) {
    return {
      type: CHANGE_LOT_PRICE,
      id,
      price
    }
  }

  function auctionReducer(state = auctionInitialState, action) {
    switch(action.type) {
      case SET_LOTS:
        return {
          ...state,
          lots: action.lots
        }
      case CHANGE_LOT_PRICE:
        return {
          ...state,
          lots: state.lots.map((lot) => {
            if (lot.id === action.id) {
              return {
                ...lot,
                price: action.price
              }
            }
            return lot
          })
        }
      default:
        return state
    }
  }

  class Store {
    constructor(reducer, initialState) {
      this.reducer = reducer
      this.state = reducer(initialState, {type: null})
      this.listeners = []
    }

    subscribe(callback) {
      this.listeners.push(callback)

      return () => {
        const index  = this.listeners.indexOf(listener)
        this.listeners.splice(index, 1)
      }
    }

    getState() {
      return this.state
    }

    dispatch(action){
      this.state = this.reducer(this.state, action)
      this.listeners.forEach((listener) => listener())
    }
  }

  function combineReducer(reducers) {
    return (state = {}, action) => {
      const result = {}
      Object.entries(reducers).forEach(([key, reducer]) => {
        result[key] = reducer(state[key], action)
      })
      return result
    }
  }

  const store = new Store(combineReducer({
    clock: clockReducer,
    auction: auctionReducer
  }))

  // Api & Strean simulation
  const api = {
    get(url) {
      switch (url) {
        case '/lots':
          return new Promise(resolve => {
            setTimeout(() => {
              resolve([
                {
                  id: 1,
                  name: 'Apple',
                  description: 'Description',
                  price: 16
                },
                {
                  id: 2,
                  name: 'Xiaomi',
                  description: 'Description',
                  price: 18
                }
              ])
            }, 1000)
          })
        default:
          throw new Error('Unknown address')

      }
    }
  }

  const stream = {
    subscribe(channel, listener) {
      const match = /price-(\d+)/.exec(channel)
      if (match) {
        setInterval(() => {
          listener({
            id: parseInt(match[1]),
            price: Math.round(Math.random() * 10 + 30)
          })
        }, 400)
      }
    }
  }

  // Render functions

  function renderView(state) {
    ReactDOM.render(<App state={state} />, document.getElementById('root'))
  }

const unsubscribe = store.subscribe(() => {
  renderView(store.getState())
})

  // Function of elements

  function Logo() {
    return <img className="logo" src="logo.png" alt=""/>

  }

  function Header() {
    return (
            <header className="header">
              <Logo />
            </header>
    )
  }



  function Clock({time}) {
    const isDay = time.getHours() >= 7 && time.getHours() <= 21

    return (
            <div className="clock">
              <span className="value">{time.toLocaleTimeString()}</span>
              <span className="{isDay ? 'icon day' : 'icon night'}"></span>
            </div>
    )
  }

  function Loading() {
    return React.createElement('div', {className: 'loading'}, 'Loading...')
}


  function Lots({lots}) {

    if (lots === null) {
      return <Loading />
    }

    return (
            <div className="lots">
              {lots.map((lot) => <Lot lot={lot} key={lot.id} />)}
            </div>
    )
  }


  function Lot({lot, key}) {
    return (
            <article className="lot">
              <div className="price">{lot.price}</div>
              <h3>{lot.name}</h3>
              <p>lot.description</p>
            </article>
    )
  }


  function App({state}) {
      return (
              <div className="app">
                <Header />
                <Clock time={state.clock.time} />
                <Lots lots={state.auction.lots} />
              </div>
      )
  }




  //Code

    const domRoot = document.getElementById('root');
  renderView(store.getState())

  setInterval(()=>{
    store.dispatch(setTime(new Date()))
  }, 1000);

  api.get('/lots').then((lots) => {
    store.dispatch(setLots(lots))
    const onPrice = (data) => {
    store.dispatch(changeLotPrice(data.id, data.price))
    }

    lots.forEach((lot) => {
      stream.subscribe(`price-${lot.id}`, onPrice)
    })
  })





</script>
</html>
