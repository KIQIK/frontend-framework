<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <link rel="stylesheet" href="style.css">
  <title>Document</title>
  <script crossorigin src="https://unpkg.com/react@16/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@16/umd/react-dom.development.js"></script>
  <script crossorigin src="https://unpkg.com/redux@4/dist/redux.js"></script>
  <script crossorigin src="https://unpkg.com/react-redux@7/dist/react-redux.js"></script>
  <script crossorigin src="https://unpkg.com/redux-thunk@2.1/dist/redux-thunk.js"></script>
  <script crossorigin src="https://unpkg.com/babel-standalone@6/babel.js"></script>
  <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
  <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>

</head>
<body>

<div id="root"></div>

</body>
<script type="text/jsx">


  const StoreContext = React.createContext()


  const SET_TIME = 'SET_TIME'

  function setTime(time) {
    return {
      type: SET_TIME,
      time
    }
  }

  const clockInitialState = {
      time: new Date()
  }

  function clockReducer(state = clockInitialState, action) {
    switch(action.type) {
      case SET_TIME:
        return {
          ...state,
          time: action.time
        }
      default:
        return state
    }
  }


  const SET_LOTS = 'SET_LOTS'
  const CHANGE_LOT_PRICE = 'CHANGE_LOT_PRICE'
  const FAVORITE_LOT = 'FAVORITE_LOT'
  const UNFAVORITE_LOT = 'UNFAVORITE_LOT'

  const auctionInitialState = {
     lots: null
  }

  function setLots(lots) {
    return {
      type: SET_LOTS,
      lots
    }
  }

  function changeLotPrice(id, price) {
    return {
      type: CHANGE_LOT_PRICE,
      id,
      price
    }
  }

  function favoriteLot(id) {
    return {
      type: FAVORITE_LOT,
      id
    }
  }

  function favoriteAsync (id) {
    return (dispatch, getState, {api}) => {
      api.post(`/lots/${id}/favorite`).then(() => {
        dispatch(favoriteLot(id))
      })
    }
  }

  function unfavoriteLot(id) {
    return {
      type: UNFAVORITE_LOT,
      id
    }
  }

  function unfavoriteAsync (id) {
    return (dispatch, getState, {api}) => {
      api.post(`/lots/${id}/unfavorite`).then(() => {
        dispatch(unfavoriteLot(id))
      })
    }
  }



  function auctionReducer(state = auctionInitialState, action) {
    switch(action.type) {
      case SET_LOTS:
        return {
          ...state,
          lots: action.lots
        }
      case CHANGE_LOT_PRICE:
        return {
          ...state,
          lots: state.lots.map((lot) => {
            if (lot.id === action.id) {
              return {
                ...lot,
                price: action.price
              }
            }
            return lot
          })
        }
      case FAVORITE_LOT:
        return {
          ...state,
          lots: state.lots.map((lot) => {
            if(lot.id === action.id) {
              return {
                ...lot,
                favorite: true
              }
            }
            return lot
          })
        }
      case UNFAVORITE_LOT:
        return {
          ...state,
          lots: state.lots.map((lot) => {
            if(lot.id === action.id) {
              return {
                ...lot,
                favorite: false
              }
            }
            return lot
          })
        }
      default:
        return state
    }
  }

  const thunk = ReduxThunk.default


  const store = new Redux.createStore(Redux.combineReducers({
    clock: clockReducer,
    auction: auctionReducer
  }),
    Redux.applyMiddleware(thunk.withExtraArgument({api}))
  )

  // Api & Strean simulation
  const api = {
    get(url) {
      switch (url) {
        case '/lots':
          return new Promise(resolve => {
            setTimeout(() => {
              resolve([
                {
                  id: 1,
                  name: 'Apple',
                  description: 'Description',
                  price: 16,
                  favorite: true
                },
                {
                  id: 2,
                  name: 'Xiaomi',
                  description: 'Description',
                  price: 18,
                  favorite: false
                }
              ])
            }, 1000)
          })
        default:
          throw new Error('Unknown address')

      }
    },
    post(url) {
      if(/^\/lots\/(\d+)\/favorite$/.exec(url)) {
        return new Promise((resolve) => {
          setTimeout(() => {
            resolve({})
          }, 500)
        })
      }
      if(/^\/lots\/(\d+)\/unfavorite$/.exec(url)) {
        return new Promise((resolve) => {
          setTimeout(() => {
            resolve({})
          }, 500)
        })
      }
    }
  }

  const stream = {
    subscribe(channel, listener) {
      const match = /price-(\d+)/.exec(channel)
      if (match) {
        setInterval(() => {
          listener({
            id: parseInt(match[1]),
            price: Math.round(Math.random() * 10 + 30)
          })
        }, 400)
      }
    }
  }

  // Render functions

  class Clock extends React.Component {
    render () {
      return (
              <div className="clock">
                <span className="value">{this.props.time.toLocaleTimeString()}</span>
              </div>
      )
    }
  }

  function renderView(store) {

    ReactDOM.render(
            <ReactRedux.Provider store={store}>
              <App />
            </ReactRedux.Provider>,
            document.getElementById('root')
    )
  }

  // Function of elements

  function App() {
    return (
            <div className="app">
              <Header />
              <ClockConnected />
              <LotsConnected />
            </div>
    )
  }


  function Logo() {
    return <img className="logo" src="logo.png" alt=""/>

  }

  function Header() {
    return (
            <header className="header">
              <Logo />
            </header>
    )
  }


  const ClockMapToProps = (state) => ({
    time: state.clock.time
  })

  const ClockConnected = ReactRedux.connect(ClockMapToProps)(Clock)


  function Loading() {
    return React.createElement('div', {className: 'loading'}, 'Loading...')
}


const LotsMapStateToProps = (state) => ({
  lots: state.auction.lots
})

  const LotsConnected = ReactRedux.connect(LotsMapStateToProps)(Lots)


  function Lots({lots}) {

    if (lots === null) {
      return <Loading />
    }

    return (
            <div className="lots">
              {lots.map((lot) => <LotConnected lot={lot} key={lot.id}/>)}
            </div>
    )
  }

  function LotsTable({lots, favorite, unfavorite}) {
    if(lots === null) {
      return <Loading />
    }

    return (
      <table  width="100%" cellPadding="10px">
        <tbody>
        {lots.map((lot)=>(
                <tr key={lot.id} style={{background: lot.favorite? '#ffd7cb' : '#fff'}} >
                  <td>{lot.name}</td>
                  <td>{lot.price}</td>
                  <td>
                    <Favorite
                            active={lot.favorite}
                            favorite={() => favorite(lot.id)}
                            unfavorite={() => unfavorite(lot.id)}
                      />
                  </td>
                </tr>
        ))}
        </tbody>
      </table>
    )
  }


  const lotMapDispatchToProps = {
    favorite: favoriteAsync,
    unfavorite: unfavoriteAsync
  }

  const LotConnected = ReactRedux.connect(null, lotMapDispatchToProps)(Lot)

  function Lot({lot, favorite, unfavorite}) {

    return (
            <article className={'lot' + (lot.favorite ? ' favorite' : '')}>
              <div className="price">{lot.price}</div>
              <h3>{lot.name}</h3>
              <p>{lot.description}</p>
              <Favorite
                      active={lot.favorite}
                      id={lot.id}
                      favorite={() => favorite(lot.id)}
                      unfavorite={() => unfavorite(lot.id)} />
            </article>
    )
  }


  function Favorite({active, favorite, unfavorite}) {
    return active
    ? (<button type="button" onClick={unfavorite} className="favorite">
              <ion-icon name="heart-sharp" /> Unfavorite
      </button>)
    : (<button type="button" onClick={favorite} className="unfavorite">
              <ion-icon name="heart-outline" /> Favorite
      </button>)
  }







  //Code



    const domRoot = document.getElementById('root');
  renderView(store)

  setInterval(()=>{
    store.dispatch(setTime(new Date()))
  }, 1000);

  api.get('/lots').then((lots) => {
    store.dispatch(setLots(lots))
    const onPrice = (data) => {
    store.dispatch(changeLotPrice(data.id, data.price))
    }

    lots.forEach((lot) => {
      stream.subscribe(`price-${lot.id}`, onPrice)
    })
  })





</script>
</html>
