<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <link rel="stylesheet" href="style.css">
  <title>Document</title>
  <script crossorigin src="https://unpkg.com/react@16/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@16/umd/react-dom.development.js"></script>
  <script crossorigin src="https://unpkg.com/babel-standalone@6/babel.js"></script>
</head>
<body>

<div id="root"></div>

</body>
<script type="text/jsx">

  //State
  const initialState = {
    time: new Date(),
    lots: null
  }

  class Store {
    constructor(initialState) {
      this.state = initialState
      this.listeners = []
    }

    subscribe(callback) {
      this.listeners.push(callback)

      return () => {
        const index  = this.listeners.indexOf(listener)
        this.listeners.splice(index, 1)
      }
    }

    getState() {
      return this.state
    }

    setState(state) {
      this.state = (typeof state === 'function' ? state(this.state) : state)
      this.listeners.forEach((listener) => listener())
    }
  }

  const store = new Store(initialState)

  // Api & Strean simulation
  const api = {
    get(url) {
      switch (url) {
        case '/lots':
          return new Promise(resolve => {
            setTimeout(() => {
              resolve([
                {
                  id: 1,
                  name: 'Apple',
                  description: 'Description',
                  price: 16
                },
                {
                  id: 2,
                  name: 'Xiaomi',
                  description: 'Description',
                  price: 18
                }
              ])
            }, 1000)
          })
        default:
          throw new Error('Unknown address')

      }
    }
  }

  const stream = {
    subscribe(channel, listener) {
      const match = /price-(\d+)/.exec(channel)
      if (match) {
        setInterval(() => {
          listener({
            id: parseInt(match[1]),
            price: Math.round(Math.random() * 10 + 30)
          })
        }, 400)
      }
    }
  }

  // Render functions

  function renderView(state) {
    ReactDOM.render(<App state={state} />, document.getElementById('root'))
  }

const unsubscribe = store.subscribe(() => {
  renderView(store.getState())
})

  // Function of elements

  function Logo() {
    return <img className="logo" src="logo.png" alt=""/>

  }

  function Header() {
    return (
            <header className="header">
              <Logo />
            </header>
    )
  }



  function Clock({time}) {
    const isDay = time.getHours() >= 7 && time.getHours() <= 21

    return (
            <div className="clock">
              <span className="value">{time.toLocaleTimeString()}</span>
              <span className="{isDay ? 'icon day' : 'icon night'}"></span>
            </div>
    )
  }

  function Loading() {
    return React.createElement('div', {className: 'loading'}, 'Loading...')
}


  function Lots({lots}) {

    if (lots === null) {
      return <Loading />
    }

    return (
            <div className="lots">
              {lots.map((lot) => <Lot lot={lot} key={lot.id} />)}
            </div>
    )
  }


  function Lot({lot, key}) {
    return (
            <article className="lot">
              <div className="price">{lot.price}</div>
              <h3>{lot.name}</h3>
              <p>lot.description</p>
            </article>
    )
  }


  function App({state}) {
      return (
              <div className="app">
                <Header />
                <Clock time={state.time} />
                <Lots lots={state.lots} />
              </div>
      )
  }




  //Code


  function appReducer(state, action, params) {
    switch(action) {
      case 'setTime':
        return {
          ...state,
          time: params.time
        }
      case 'setLots':
        return {
          ...state,
          lots: state.lots.map((lot) => {
            if (lot.id === params.id) {
              return {
                ...lot,
                price: params.price
              }
            }
            return lot
          })
        }
        case 'changeLotPrice':
          return {
            ...state,
            lots: state.lots.map((lot) => {
              if (lot.id === params.id) {
                return {
                  ...lot,
                  price: params.price
                }
              }
              return lot
            })
          }
      default:
        return state
    }
  }

  const domRoot = document.getElementById('root');
  renderView(store.getState())

  setInterval(()=>{
    store.setState((state) => appReducer(state, 'setTime', {time: new Date()}))

  }, 1000);

  api.get('/lots').then((lots) => {
    store.setState((state) => appReducer(state, 'setLots', {time: new Date()}))

    const onPrice = (data) => {
      store.setState((state) => appReducer(state, 'changeLotPrice', {time: new Date()}))
    }

    lots.forEach((lot) => {
      stream.subscribe(`price-${lot.id}`, onPrice)
    })
  })





</script>
</html>
